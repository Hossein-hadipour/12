<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¢Ù…ÙˆØ²Ø´ Ùˆ Ù¾Ø±ÙˆØ±Ø´ - Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù…Ø¯ÛŒØ±ÛŒØª</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.180.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/fontawesome@6.6.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vazirmatn@33.0.0/Vazirmatn-font-face.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            font-size: 12px;
            margin: 0;
            padding: 0;
            color: #fff;
            background: linear-gradient(135deg, #1a237e, #4fc3f7);
            overflow-x: hidden;
            animation: backgroundFlow 15s infinite ease-in-out;
            transition: background 0.3s;
        }
        body.dark-mode {
            background: linear-gradient(135deg, #121212, #424242);
            color: #ddd;
        }
        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://images.unsplash.com/photo-1503676260728-1f548d3d6f88') no-repeat center center fixed;
            background-size: cover;
            opacity: 0.3;
            z-index: -1;
            transform: translateZ(0);
        }
        @keyframes backgroundFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            transform-style: preserve-3d;
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0) rotateX(0deg) rotateY(0deg); }
            50% { transform: translateY(-20px) rotateX(5deg) rotateY(5deg); }
            100% { transform: translateY(0) rotateX(0deg) rotateY(0deg); }
        }
        .header {
            background: linear-gradient(90deg, #d81b60, #8e24aa);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 14px;
            border-radius: 10px;
            animation: pulseGlow 2s infinite ease-in-out;
        }
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 10px rgba(216, 27, 96, 0.7); }
            50% { box-shadow: 0 0 20px rgba(216, 27, 96, 1); }
            100% { box-shadow: 0 0 10px rgba(216, 27, 96, 0.7); }
        }
        .dashboard {
            display: none;
            animation: zoomIn3D 0.8s ease;
        }
        @keyframes zoomIn3D {
            from { transform: scale(0.8) rotateX(-10deg); opacity: 0; }
            to { transform: scale(1) rotateX(0deg); opacity: 1; }
        }
        .active { display: block; }
        button {
            padding: 8px 16px;
            margin: 5px;
            background: linear-gradient(45deg, #ff4081, #7c4dff);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            transform-style: preserve-3d;
        }
        button:hover {
            transform: translateZ(10px) scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .small-btn {
            padding: 4px 8px;
            font-size: 10px;
        }
        input, select, textarea {
            padding: 8px;
            margin: 5px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            width: calc(100% - 20px);
            transition: border 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border: 1px solid #ff4081;
            outline: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
        }
        th, td {
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px;
            text-align: center;
            color: white;
        }
        th {
            background: linear-gradient(45deg, #0288d1, #4fc3f7);
            cursor: pointer;
        }
        canvas {
            display: block;
            margin: 20px auto;
            border-radius: 10px;
        }
        .star-rating { display: inline-block; }
        .star-rating input { display: none; }
        .star-rating label {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: color 0.3s;
        }
        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #ffca28;
        }
        .file-preview {
            max-width: 100px;
            max-height: 100px;
            margin: 5px;
            border-radius: 5px;
        }
        @media (max-width: 600px) {
            .container { padding: 10px; }
            button { padding: 6px 12px; }
            input, select, textarea { width: 100%; }
        }
        footer {
            background: linear-gradient(90deg, #d81b60, #8e24aa);
            color: white;
            text-align: center;
            padding: 10px;
            position: relative;
            bottom: 0;
            width: 100%;
            border-radius: 0 0 10px 10px;
            animation: slideUp 1s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        #login {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            text-align: center;
        }
        #login input {
            margin: 10px 0;
            width: 80%;
        }
        #login button {
            width: 50%;
        }
    </style>
</head>
<body>
    <div class="background-overlay"></div>
    <div class="header">
        ï·½ Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÛŒÙ… ğŸ“–<br>
        Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ø¢Ù…ÙˆØ²Ø´ Ùˆ Ù¾Ø±ÙˆØ±Ø´ ğŸ«<br>
        ØªØ§Ø±ÛŒØ®: <span id="date"></span> ğŸ“…
        <button onclick="toggleTheme()" style="float: left;"><i class="fas fa-moon"></i></button>
    </div>
    <div class="container">
        <!-- ØµÙØ­Ù‡ Ù„ÙˆÚ¯ÛŒÙ† Ø³Ø§Ø¯Ù‡ -->
        <div id="login" class="dashboard active">
            <h2><i class="fas fa-sign-in-alt"></i> ÙˆØ±ÙˆØ¯</h2>
            <input type="text" id="username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (1)" value="1">
            <input type="password" id="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (1)" value="1">
            <button onclick="login()"><i class="fas fa-sign-in-alt"></i> ÙˆØ±ÙˆØ¯</button>
            <p id="login-error" style="color: #ff4081;"></p>
        </div>

        <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§ØµÙ„ÛŒ -->
        <div id="main-dashboard" class="dashboard">
            <h2><i class="fas fa-tachometer-alt"></i> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§ØµÙ„ÛŒ</h2>
            <p>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: <span id="current-username"></span> <i class="fas fa-user"></i></p>
            <input type="password" id="new-password" placeholder="ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯">
            <button onclick="changePassword()">ØªØºÛŒÛŒØ± Ø±Ù…Ø² <i class="fas fa-key"></i></button>
            <button onclick="showDashboard('people-def')">ØªØ¹Ø±ÛŒÙ Ø§ÙØ±Ø§Ø¯ <i class="fas fa-users"></i></button>
            <button onclick="showDashboard('people-table')">Ø¬Ø¯ÙˆÙ„ Ø§ÙØ±Ø§Ø¯ <i class="fas fa-table"></i></button>
            <button onclick="showDashboard('criteria-def')">ØªØ¹Ø±ÛŒÙ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ <i class="fas fa-ruler"></i></button>
            <button onclick="showDashboard('reportcard')">Ú©Ø§Ø±Ù†Ø§Ù…Ù‡ <i class="fas fa-file-alt"></i></button>
            <button onclick="showDashboard('notes')">ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ <i class="fas fa-sticky-note"></i></button>
            <button onclick="showDashboard('folder')">Ù¾ÙˆØ´Ù‡ Ú©Ø§Ø± <i class="fas fa-folder"></i></button>
            <button onclick="showDashboard('files')">ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§ÙØ±Ø§Ø¯ <i class="fas fa-file"></i></button>
            <button onclick="showDashboard('chart')">Ù†Ù…ÙˆØ¯Ø§Ø± Ù…Ø¹Ø¯Ù„ <i class="fas fa-chart-bar"></i></button>
            <button onclick="showDashboard('summary')">Ø®Ù„Ø§ØµÙ‡ Ú¯Ø²Ø§Ø±Ø´ <i class="fas fa-clipboard-list"></i></button>
            <button onclick="showDashboard('rewards')">Ù¾Ø§Ø¯Ø§Ø´ Ùˆ Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø§Ø±ÛŒ <i class="fas fa-money-bill"></i></button>
            <button onclick="exportData()">Ø®Ø±ÙˆØ¬ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ <i class="fas fa-download"></i></button>
            <button onclick="logout()">Ø®Ø±ÙˆØ¬ <i class="fas fa-sign-out-alt"></i></button>
        </div>

        <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ¹Ø±ÛŒÙ Ø§ÙØ±Ø§Ø¯ -->
        <div id="people-def" class="dashboard">
            <h2><i class="fas fa-users"></i> ØªØ¹Ø±ÛŒÙ Ø§ÙØ±Ø§Ø¯</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">Ø¨Ø§Ø²Ú¯Ø´Øª <i class="fas fa-arrow-right"></i></button>
            <input type="text" id="person-name" placeholder="Ù†Ø§Ù…">
            <input type="text" id="person-role" placeholder="Ù†Ù‚Ø´ ÙØ±Ø¯">
            <input type="text" id="person-personnel" placeholder="Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ">
            <input type="text" id="person-father" placeholder="Ù†Ø§Ù… Ù¾Ø¯Ø±">
            <input type="text" id="person-other" placeholder="Ù…Ø´Ø®ØµØ§Øª Ø¯ÛŒÚ¯Ø±">
            <select id="person-filter">
                <option>ÙÛŒÙ„ØªØ±: Ù‡Ù…Ù‡</option>
                <option>ÙØ¹Ø§Ù„</option>
                <option>ØºÛŒØ±ÙØ¹Ø§Ù„</option>
            </select>
            <button onclick="addPerson()">Ø«Ø¨Øª <i class="fas fa-plus"></i></button>
            <table id="people-table-def">
                <tr><th>Ù†Ø§Ù…</th><th>Ù†Ù‚Ø´</th><th>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</th><th>Ù†Ø§Ù… Ù¾Ø¯Ø±</th><th>Ø¯ÛŒÚ¯Ø±</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
            </table>
        </div>

        <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¬Ø¯ÙˆÙ„ Ø§ÙØ±Ø§Ø¯ -->
        <div id="people-table" class="dashboard">
            <h2><i class="fas fa-table"></i> Ø¬Ø¯ÙˆÙ„ Ø§ÙØ±Ø§Ø¯</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">Ø¨Ø§Ø²Ú¯Ø´Øª <i class="fas fa-arrow-right"></i></button>
            <input type="text" id="search-people" placeholder="Ø¬Ø³ØªØ¬Ùˆ...">
            <table id="people-table-full">
                <tr><th onclick="sortTable(0)">Ù†Ø§Ù…</th><th onclick="sortTable(1)">Ù†Ù‚Ø´</th><th onclick="sortTable(2)">Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</th><th onclick="sortTable(3)">Ù†Ø§Ù… Ù¾Ø¯Ø±</th><th onclick="sortTable(4)">Ø¯ÛŒÚ¯Ø±</th><th onclick="sortTable(5)">Ù†Ù…Ø±Ù‡ Ø§Ø±Ø²Ø´ÛŒØ§Ø¨ÛŒ â­</th><th onclick="sortTable(6)">Ù…Ø¹Ø¯Ù„ â­</th></tr>
            </table>
        </div>

        <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ¹Ø±ÛŒÙ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ -->
        <div id="criteria-def" class="dashboard">
            <h2><i class="fas fa-ruler"></i> ØªØ¹Ø±ÛŒÙ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">Ø¨Ø§Ø²Ú¯Ø´Øª <i class="fas fa-arrow-right"></i></button>
            <input type="text" id="criterion-name" placeholder="Ù†Ø§Ù… Ù…Ø¹ÛŒØ§Ø±">
            <button onclick="addCriterion()">Ø§Ø¶Ø§ÙÙ‡ <i class="fas fa-plus"></i></button>
            <table id="criteria-table">
                <tr><th>Ù…Ø¹ÛŒØ§Ø±</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
            </table>
        </div>

        <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ø±Ù†Ø§Ù…Ù‡ -->
        <div id="reportcard" class="dashboard">
            <h2><i class="fas fa-file-alt"></i> Ú©Ø§Ø±Ù†Ø§Ù…Ù‡</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">Ø¨Ø§Ø²Ú¯Ø´Øª <i class="fas fa-arrow-right"></i></button>
            <select id="person-select-rc"></select>
            <div id="criteria-ratings"></div>
            <button onclick="saveReportCard()">Ø°Ø®ÛŒØ±Ù‡ <i class="fas fa-save"></i></button>
            <p>Ù…Ø¹Ø¯Ù„: <span id="average-rc"></span> â­</p>
        </div>

        <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ -->
        <div id="notes" class="dashboard">
            <h2><i class="fas fa-sticky-note"></i> ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">Ø¨Ø§Ø²Ú¯Ø´Øª <i class="fas fa-arrow-right"></i></button>
            <select id="person-select-notes"></select>
            <textarea id="note-text" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯"></textarea>
            <button onclick="addNote()">Ø§Ø¶Ø§ÙÙ‡ <i class="fas fa-plus"></i></button>
            <ul id="notes-list"></ul>
        </div>

        <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù¾ÙˆØ´Ù‡ Ú©Ø§Ø± -->
        <div id="folder" class="dashboard">
            <h2><i class="fas fa-folder"></i> Ù¾ÙˆØ´Ù‡ Ú©Ø§Ø±</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">Ø¨Ø§Ø²Ú¯Ø´Øª <i class="fas fa-arrow-right"></i></button>
            <input type="file" id="folder-file" multiple>
            <input type="text" id="folder-desc" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª ÙØ§ÛŒÙ„">
            <img id="folder-preview" class="file-preview" style="display: none;">
            <button onclick="addFolderFile()">Ø§ÙØ²ÙˆØ¯Ù† <i class="fas fa-plus"></i></button>
            <table id="folder-table">
                <tr><th>Ù†Ø§Ù… ÙØ§ÛŒÙ„</th><th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
            </table>
        </div>

        <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§ÙØ±Ø§Ø¯ -->
        <div id="files" class="dashboard">
            <h2><i class="fas fa-file"></i> ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§ÙØ±Ø§Ø¯</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">Ø¨Ø§Ø²Ú¯Ø´Øª <i class="fas fa-arrow-right"></i></button>
            <select id="person-select-files"></select>
            <input type="file" id="person-file" multiple>
            <input type="text" id="person-desc" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª ÙØ§ÛŒÙ„">
            <img id="person-preview" class="file-preview" style="display: none;">
            <button onclick="addPersonFile()">Ø§ÙØ²ÙˆØ¯Ù† <i class="fas fa-plus"></i></button>
            <button onclick="printAllFiles()">Ù¾Ø±ÛŒÙ†Øª Ù‡Ù…Ù‡ <i class="fas fa-print"></i></button>
            <table id="files-table">
                <tr><th>Ù†Ø§Ù… ÙØ§ÛŒÙ„</th><th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
            </table>
        </div>

        <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†Ù…ÙˆØ¯Ø§Ø± -->
        <div id="chart" class="dashboard">
            <h2><i class="fas fa-chart-bar"></i> Ù†Ù…ÙˆØ¯Ø§Ø± Ù…Ø¹Ø¯Ù„</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">Ø¨Ø§Ø²Ú¯Ø´Øª <i class="fas fa-arrow-right"></i></button>
            <canvas id="average-chart" width="400" height="200"></canvas>
        </div>

        <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø®Ù„Ø§ØµÙ‡ Ú¯Ø²Ø§Ø±Ø´ -->
        <div id="summary" class="dashboard">
            <h2><i class="fas fa-clipboard-list"></i> Ø®Ù„Ø§ØµÙ‡ Ú¯Ø²Ø§Ø±Ø´</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">Ø¨Ø§Ø²Ú¯Ø´Øª <i class="fas fa-arrow-right"></i></button>
            <select id="person-select-summary" onchange="updateSummary()"></select>
            <button onclick="printSummary()">Ù¾Ø±ÛŒÙ†Øª Ú¯Ø²Ø§Ø±Ø´ <i class="fas fa-print"></i></button>
            <div id="summary-content"></div>
        </div>

        <!-- Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù¾Ø§Ø¯Ø§Ø´ Ùˆ Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø§Ø±ÛŒ -->
        <div id="rewards" class="dashboard">
            <h2><i class="fas fa-money-bill"></i> Ù¾Ø§Ø¯Ø§Ø´ Ùˆ Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø§Ø±ÛŒ</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">Ø¨Ø§Ø²Ú¯Ø´Øª <i class="fas fa-arrow-right"></i></button>
            <select id="person-select-rewards"></select>
            <input type="number" id="reward-amount" placeholder="Ù…Ø¨Ù„Øº Ù¾Ø§Ø¯Ø§Ø´">
            <input type="number" id="overtime-hours" placeholder="Ø³Ø§Ø¹Ø§Øª Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø§Ø±ÛŒ">
            <button onclick="addReward()">Ø§Ø¶Ø§ÙÙ‡ <i class="fas fa-plus"></i></button>
            <table id="rewards-table">
                <tr><th>Ù¾Ø§Ø¯Ø§Ø´</th><th>Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø§Ø±ÛŒ</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
            </table>
            <p>Ø¬Ù…Ø¹ Ú©Ù„: <span id="total-rewards">0</span> <i class="fas fa-money-bill"></i></p>
            <canvas id="rewards-chart" width="400" height="200"></canvas>
        </div>
    </div>
    <footer>
        Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø­Ø³ÛŒÙ† Ù‡Ø§Ø¯ÛŒ Ù¾ÙˆØ± â¤ï¸
    </footer>

    <script>
        // IndexedDB Setup
        let db;
        const request = indexedDB.open('EducationAppDB', 1);
        request.onupgradeneeded = event => {
            db = event.target.result;
            db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
        };
        request.onsuccess = event => {
            db = event.target.result;
        };
        request.onerror = () => console.error('IndexedDB error');

        let username = localStorage.getItem('username') || '1';
        let password = localStorage.getItem('password') || '1';
        let loggedIn = false;
        let people = JSON.parse(LZString.decompress(localStorage.getItem('people'))) || [];
        let criteria = JSON.parse(LZString.decompress(localStorage.getItem('criteria'))) || [
            "Ø²Ù…Ø§Ù†â€ŒØ´Ù†Ø§Ø³ÛŒ â±ï¸", "Ú©Ø§Ø± ØªÛŒÙ…ÛŒ ğŸ¤", "Ú©ÛŒÙÛŒØª Ú©Ø§Ø± ğŸ†", "Ø§Ø¨ØªÚ©Ø§Ø± ğŸ’¡", "Ù…Ø³Ø¦ÙˆÙ„ÛŒØªâ€ŒÙ¾Ø°ÛŒØ±ÛŒ ğŸ“Œ",
            "Ù…Ù‡Ø§Ø±Øª Ø§Ø±ØªØ¨Ø§Ø·ÛŒ ğŸ—£ï¸", "ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ù…Ø¯Ø§ÙˆÙ… ğŸ“š", "Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù† âŒ›", "Ø­Ù„ Ù…Ø³Ø¦Ù„Ù‡ ğŸ§©", "Ø§Ù†Ø·Ø¨Ø§Ù‚â€ŒÙ¾Ø°ÛŒØ±ÛŒ ğŸ”„",
            "Ø±Ù‡Ø¨Ø±ÛŒ ğŸ‘‘", "Ø§Ø®Ù„Ø§Ù‚ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ âš–ï¸", "Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ âš™ï¸", "Ù…Ø´Ø§Ø±Ú©Øª ğŸ‰", "Ø±Ø¶Ø§ÛŒØª Ù…Ø´ØªØ±ÛŒ ğŸ˜Š"
        ];
        let reportcards = JSON.parse(LZString.decompress(localStorage.getItem('reportcards'))) || {};
        let notes = JSON.parse(LZString.decompress(localStorage.getItem('notes'))) || {};
        let folderFiles = JSON.parse(LZString.decompress(localStorage.getItem('folderFiles'))) || [];
        let personFiles = JSON.parse(LZString.decompress(localStorage.getItem('personFiles'))) || {};
        let rewards = JSON.parse(LZString.decompress(localStorage.getItem('rewards'))) || {};

        // Three.js Animation (Optimized)
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        renderer.domElement.style.position = 'fixed';
        renderer.domElement.style.top = '0';
        renderer.domElement.style.left = '0';
        renderer.domElement.style.zIndex = '-2';
        renderer.domElement.style.pointerEvents = 'none';

        const geometry = new THREE.BufferGeometry();
        const vertices = [];
        for (let i = 0; i < 50; i++) {
            vertices.push(
                Math.random() * 100 - 50,
                Math.random() * 100 - 50,
                Math.random() * 100 - 50
            );
        }
        geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
        const material = new THREE.PointsMaterial({ color: 0xff4081, size: 0.5 });
        const particles = new THREE.Points(geometry, material);
        scene.add(particles);
        const light = new THREE.PointLight(0xffffff, 1, 100);
        light.position.set(10, 10, 10);
        scene.add(light);
        camera.position.z = 50;

        function animateParticles() {
            particles.rotation.y += 0.01;
            renderer.render(scene, camera);
            requestAnimationFrame(animateParticles);
        }
        animateParticles();

        // Theme Toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

        // Date Setup
        document.getElementById('date').innerText = new Date().toLocaleDateString('fa-IR');

        function saveData() {
            try {
                localStorage.setItem('username', username);
                localStorage.setItem('password', password);
                localStorage.setItem('people', LZString.compress(JSON.stringify(people)));
                localStorage.setItem('criteria', LZString.compress(JSON.stringify(criteria)));
                localStorage.setItem('reportcards', LZString.compress(JSON.stringify(reportcards)));
                localStorage.setItem('notes', LZString.compress(JSON.stringify(notes)));
                localStorage.setItem('folderFiles', LZString.compress(JSON.stringify(folderFiles)));
                localStorage.setItem('personFiles', LZString.compress(JSON.stringify(personFiles)));
                localStorage.setItem('rewards', LZString.compress(JSON.stringify(rewards)));
            } catch (e) {
                Swal.fire({
                    icon: 'error',
                    title: 'Ø®Ø·Ø§',
                    text: 'Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ Ù¾Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ø®ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯.',
                });
            }
        }

        function login() {
            const un = document.getElementById('username').value.trim();
            const pw = document.getElementById('password').value.trim();
            if (!un || !pw) {
                Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§', text: 'Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.' });
                return;
            }
            if (un === username && pw === password) {
                loggedIn = true;
                showDashboard('main-dashboard');
                document.getElementById('current-username').innerText = username;
                loadAll();
                Swal.fire({ icon: 'success', title: 'Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!', timer: 1500, showConfirmButton: false });
            } else {
                document.getElementById('login-error').innerText = 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª âŒ';
            }
        }

        function changePassword() {
            const newPw = document.getElementById('new-password').value.trim();
            if (newPw && newPw.length >= 4) {
                password = newPw;
                saveData();
                Swal.fire({ icon: 'success', title: 'Ø±Ù…Ø² ØªØºÛŒÛŒØ± ÛŒØ§ÙØª', timer: 1500 });
            } else {
                Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§', text: 'Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û´ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.' });
            }
        }

        function logout() {
            loggedIn = false;
            showDashboard('login');
            Swal.fire({ icon: 'info', title: 'Ø®Ø±ÙˆØ¬', text: 'Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.', timer: 1500 });
        }

        function showDashboard(id) {
            document.querySelectorAll('.dashboard').forEach(d => d.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'people-def') loadPeopleDef();
            if (id === 'people-table') loadPeopleTable();
            if (id === 'criteria-def') loadCriteria();
            if (id === 'reportcard') loadReportCard();
            if (id === 'notes') loadNotes();
            if (id === 'folder') loadFolder();
            if (id === 'files') loadFiles();
            if (id === 'chart') loadChart();
            if (id === 'summary') loadSummary();
            if (id === 'rewards') loadRewards();
        }

        function addPerson() {
            const name = document.getElementById('person-name').value.trim();
            const role = document.getElementById('person-role').value.trim();
            const personnel = document.getElementById('person-personnel').value.trim();
            const father = document.getElementById('person-father').value.trim();
            const other = document.getElementById('person-other').value.trim();
            if (!name) {
                Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§', text: 'Ù†Ø§Ù… Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.' });
                return;
            }
            people.push({name, role, personnel, father, other});
            saveData();
            loadPeopleDef();
            Swal.fire({ icon: 'success', title: 'Ø«Ø¨Øª Ø´Ø¯', text: 'ÙØ±Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.', timer: 1500 });
        }

        function loadPeopleDef() {
            const table = document.getElementById('people-table-def');
            table.innerHTML = '<tr><th>Ù†Ø§Ù…</th><th>Ù†Ù‚Ø´</th><th>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</th><th>Ù†Ø§Ù… Ù¾Ø¯Ø±</th><th>Ø¯ÛŒÚ¯Ø±</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>';
            people.forEach((p, i) => {
                const row = table.insertRow();
                row.innerHTML = `<td>${p.name}</td><td>${p.role || ''}</td><td>${p.personnel || ''}</td><td>${p.father || ''}</td><td>${p.other || ''}</td>
                    <td><button class="small-btn" onclick="editPerson(${i})">ÙˆÛŒØ±Ø§ÛŒØ´ <i class="fas fa-edit"></i></button><button class="small-btn" onclick="deletePerson(${i})">Ø­Ø°Ù <i class="fas fa-trash"></i></button></td>`;
            });
        }

        function editPerson(i) {
            const p = people[i];
            document.getElementById('person-name').value = p.name;
            document.getElementById('person-role').value = p.role;
            document.getElementById('person-personnel').value = p.personnel;
            document.getElementById('person-father').value = p.father;
            document.getElementById('person-other').value = p.other;
            people.splice(i, 1);
            saveData();
        }

        function deletePerson(i) {
            Swal.fire({
                title: 'Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ',
                text: 'Ø§ÛŒÙ† ÙØ±Ø¯ Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†',
                cancelButtonText: 'Ø®ÛŒØ±'
            }).then(result => {
                if (result.isConfirmed) {
                    people.splice(i, 1);
                    saveData();
                    loadPeopleDef();
                    Swal.fire({ icon: 'success', title: 'Ø­Ø°Ù Ø´Ø¯', timer: 1500 });
                }
            });
        }

        function loadPeopleTable() {
            const table = document.getElementById('people-table-full');
            table.innerHTML = '<tr><th onclick="sortTable(0)">Ù†Ø§Ù…</th><th onclick="sortTable(1)">Ù†Ù‚Ø´</th><th onclick="sortTable(2)">Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</th><th onclick="sortTable(3)">Ù†Ø§Ù… Ù¾Ø¯Ø±</th><th onclick="sortTable(4)">Ø¯ÛŒÚ¯Ø±</th><th onclick="sortTable(5)">Ù†Ù…Ø±Ù‡ Ø§Ø±Ø²Ø´ÛŒØ§Ø¨ÛŒ â­</th><th onclick="sortTable(6)">Ù…Ø¹Ø¯Ù„ â­</th></tr>';
            const search = document.getElementById('search-people').value.toLowerCase();
            people.filter(p => p.name.toLowerCase().includes(search) || (p.role || '').toLowerCase().includes(search)).forEach(p => {
                const ratings = reportcards[p.name] || criteria.map(() => 0);
                const avg = ratings.reduce((a, b) => a + b, 0) / ratings.length || 0;
                const evalScore = avg * 5;
                const row = table.insertRow();
                row.innerHTML = `<td>${p.name}</td><td>${p.role || ''}</td><td>${p.personnel || ''}</td><td>${p.father || ''}</td><td>${p.other || ''}</td>
                    <td>${evalScore.toFixed(2)}</td><td>${avg.toFixed(2)}</td>`;
            });
        }

        document.getElementById('search-people').addEventListener('input', loadPeopleTable);

        function sortTable(col) {
            people.sort((a, b) => {
                const values = [
                    a.name, a.role || '', a.personnel || '', a.father || '', a.other || '',
                    (reportcards[a.name] || criteria.map(() => 0)).reduce((x, y) => x + y, 0) / criteria.length || 0,
                    (reportcards[b.name] || criteria.map(() => 0)).reduce((x, y) => x + y, 0) / criteria.length || 0
                ];
                return values[col] > values[col + 5] ? 1 : -1;
            });
            loadPeopleTable();
        }

        function addCriterion() {
            const name = document.getElementById('criterion-name').value.trim();
            if (name) {
                criteria.push(name);
                saveData();
                loadCriteria();
                Swal.fire({ icon: 'success', title: 'Ù…Ø¹ÛŒØ§Ø± Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', timer: 1500 });
            }
        }

        function loadCriteria() {
            const table = document.getElementById('criteria-table');
            table.innerHTML = '<tr><th>Ù…Ø¹ÛŒØ§Ø±</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>';
            criteria.forEach((c, i) => {
                const row = table.insertRow();
                row.innerHTML = `<td>${c}</td><td><button class="small-btn" onclick="editCriterion(${i})">ÙˆÛŒØ±Ø§ÛŒØ´ <i class="fas fa-edit"></i></button><button class="small-btn" onclick="deleteCriterion(${i})">Ø­Ø°Ù <i class="fas fa-trash"></i></button></td>`;
            });
        }

        function editCriterion(i) {
            document.getElementById('criterion-name').value = criteria[i];
            criteria.splice(i, 1);
            saveData();
        }

        function deleteCriterion(i) {
            Swal.fire({
                title: 'Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ',
                text: 'Ø§ÛŒÙ† Ù…Ø¹ÛŒØ§Ø± Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†',
                cancelButtonText: 'Ø®ÛŒØ±'
            }).then(result => {
                if (result.isConfirmed) {
                    criteria.splice(i, 1);
                    saveData();
                    loadCriteria();
                    Swal.fire({ icon: 'success', title: 'Ø­Ø°Ù Ø´Ø¯', timer: 1500 });
                }
            });
        }

        function loadReportCard() {
            const select = document.getElementById('person-select-rc');
            select.innerHTML = '';
            people.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.text = p.name;
                select.add(opt);
            });
            select.onchange = updateRatings;
            updateRatings();
        }

        function updateRatings() {
            const name = document.getElementById('person-select-rc').value;
            const div = document.getElementById('criteria-ratings');
            div.innerHTML = '';
            criteria.forEach((c, i) => {
                const ratingDiv = document.createElement('div');
                ratingDiv.innerHTML = `${c}: <div class="star-rating">
                    ${[5,4,3,2,1].map(n => `<input type="radio" id="star${i}-${n}" name="rate${i}" value="${n}" ${ (reportcards[name] && reportcards[name][i] === n) ? 'checked' : '' }><label for="star${i}-${n}">â˜…</label>`).join('')}
                </div>`;
                div.appendChild(ratingDiv);
            });
            calculateAverage(name);
        }

        function saveReportCard() {
            const name = document.getElementById('person-select-rc').value;
            reportcards[name] = criteria.map((_, i) => parseInt(document.querySelector(`input[name="rate${i}"]:checked`)?.value || 0));
            saveData();
            calculateAverage(name);
            Swal.fire({ icon: 'success', title: 'Ú©Ø§Ø±Ù†Ø§Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', timer: 1500 });
        }

        function calculateAverage(name) {
            const ratings = reportcards[name] || [];
            const avg = ratings.reduce((a, b) => a + b, 0) / ratings.length || 0;
            document.getElementById('average-rc').innerText = avg.toFixed(2);
        }

        function loadNotes() {
            const select = document.getElementById('person-select-notes');
            select.innerHTML = '';
            people.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.text = p.name;
                select.add(opt);
            });
            select.onchange = updateNotes;
            updateNotes();
        }

        function addNote() {
            const name = document.getElementById('person-select-notes').value;
            const text = document.getElementById('note-text').value.trim();
            if (text) {
                if (!notes[name]) notes[name] = [];
                notes[name].push(text);
                saveData();
                updateNotes();
                Swal.fire({ icon: 'success', title: 'ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', timer: 1500 });
            }
        }

        function updateNotes() {
            const name = document.getElementById('person-select-notes').value;
            const ul = document.getElementById('notes-list');
            ul.innerHTML = '';
            (notes[name] || []).forEach((n, i) => {
                const li = document.createElement('li');
                li.innerHTML = `${n} <button class="small-btn" onclick="editNote('${name}', ${i})">ÙˆÛŒØ±Ø§ÛŒØ´ <i class="fas fa-edit"></i></button><button class="small-btn" onclick="deleteNote('${name}', ${i})">Ø­Ø°Ù <i class="fas fa-trash"></i></button>`;
                ul.appendChild(li);
            });
        }

        function editNote(name, i) {
            document.getElementById('note-text').value = notes[name][i];
            notes[name].splice(i, 1);
            saveData();
        }

        function deleteNote(name, i) {
            Swal.fire({
                title: 'Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ',
                text: 'Ø§ÛŒÙ† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†',
                cancelButtonText: 'Ø®ÛŒØ±'
            }).then(result => {
                if (result.isConfirmed) {
                    notes[name].splice(i, 1);
                    saveData();
                    updateNotes();
                    Swal.fire({ icon: 'success', title: 'Ø­Ø°Ù Ø´Ø¯', timer: 1500 });
                }
            });
        }

        function loadFolder() {
            const table = document.getElementById('folder-table');
            table.innerHTML = '<tr><th>Ù†Ø§Ù… ÙØ§ÛŒÙ„</th><th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>';
            folderFiles.forEach((f, i) => {
                const row = table.insertRow();
                row.innerHTML = `<td>${f.name}</td><td>${f.desc || ''}</td><td><button class="small-btn" onclick="downloadFile(${f.id}, '${f.name}')">Ø¯Ø§Ù†Ù„ÙˆØ¯ <i class="fas fa-download"></i></button><button class="small-btn" onclick="printFile(${f.id})">Ù¾Ø±ÛŒÙ†Øª <i class="fas fa-print"></i></button><button class="small-btn" onclick="deleteFolderFile(${i}, ${f.id})">Ø­Ø°Ù <i class="fas fa-trash"></i></button></td>`;
            });
        }

        function addFolderFile() {
            const fileInput = document.getElementById('folder-file');
            const desc = document.getElementById('folder-desc').value.trim();
            const files = Array.from(fileInput.files);
            if (files.length === 0) return;
            files.forEach(file => {
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§', text: 'Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ú©Ù…ØªØ± Ø§Ø² Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯.' });
                    return;
                }
                const reader = new FileReader();
                reader.onload = e => {
                    const transaction = db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const fileData = { name: file.name, data: e.target.result, desc };
                    const request = store.add(fileData);
                    request.onsuccess = () => {
                        folderFiles.push({ name: file.name, desc, id: request.result });
                        saveData();
                        loadFolder();
                        Swal.fire({ icon: 'success', title: 'ÙØ§ÛŒÙ„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', timer: 1500 });
                    };
                };
                reader.readAsDataURL(file);
            });
            document.getElementById('folder-preview').style.display = 'none';
        }

        document.getElementById('folder-file').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const preview = document.getElementById('folder-preview');
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            }
        });

        function deleteFolderFile(index, id) {
            Swal.fire({
                title: 'Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ',
                text: 'Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†',
                cancelButtonText: 'Ø®ÛŒØ±'
            }).then(result => {
                if (result.isConfirmed) {
                    const transaction = db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    store.delete(id);
                    folderFiles.splice(index, 1);
                    saveData();
                    loadFolder();
                    Swal.fire({ icon: 'success', title: 'Ø­Ø°Ù Ø´Ø¯', timer: 1500 });
                }
            });
        }

        function loadFiles() {
            const select = document.getElementById('person-select-files');
            select.innerHTML = '';
            people.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.text = p.name;
                select.add(opt);
            });
            select.onchange = updateFiles;
            updateFiles();
        }

        function addPersonFile() {
            const name = document.getElementById('person-select-files').value;
            const fileInput = document.getElementById('person-file');
            const desc = document.getElementById('person-desc').value.trim();
            const files = Array.from(fileInput.files);
            if (files.length === 0) return;
            files.forEach(file => {
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§', text: 'Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ú©Ù…ØªØ± Ø§Ø² Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯.' });
                    return;
                }
                const reader = new FileReader();
                reader.onload = e => {
                    const transaction = db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const fileData = { name: file.name, data: e.target.result, desc, person: name };
                    const request = store.add(fileData);
                    request.onsuccess = () => {
                        if (!personFiles[name]) personFiles[name] = [];
                        personFiles[name].push({ name: file.name, desc, id: request.result });
                        saveData();
                        updateFiles();
                        Swal.fire({ icon: 'success', title: 'ÙØ§ÛŒÙ„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', timer: 1500 });
                    };
                };
                reader.readAsDataURL(file);
            });
            document.getElementById('person-preview').style.display = 'none';
        }

        document.getElementById('person-file').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const preview = document.getElementById('person-preview');
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            }
        });

        function updateFiles() {
            const name = document.getElementById('person-select-files').value;
            const table = document.getElementById('files-table');
            table.innerHTML = '<tr><th>Ù†Ø§Ù… ÙØ§ÛŒÙ„</th><th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>';
            (personFiles[name] || []).forEach((f, i) => {
                const row = table.insertRow();
                row.innerHTML = `<td>${f.name}</td><td>${f.desc || ''}</td><td><button class="small-btn" onclick="downloadFile(${f.id}, '${f.name}')">Ø¯Ø§Ù†Ù„ÙˆØ¯ <i class="fas fa-download"></i></button><button class="small-btn" onclick="printFile(${f.id})">Ù¾Ø±ÛŒÙ†Øª <i class="fas fa-print"></i></button><button class="small-btn" onclick="deletePersonFile('${name}', ${i}, ${f.id})">Ø­Ø°Ù <i class="fas fa-trash"></i></button></td>`;
            });
        }

        function deletePersonFile(name, index, id) {
            Swal.fire({
                title: 'Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ',
                text: 'Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†',
                cancelButtonText: 'Ø®ÛŒØ±'
            }).then(result => {
                if (result.isConfirmed) {
                    const transaction = db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    store.delete(id);
                    personFiles[name].splice(index, 1);
                    saveData();
                    updateFiles();
                    Swal.fire({ icon: 'success', title: 'Ø­Ø°Ù Ø´Ø¯', timer: 1500 });
                }
            });
        }

        function downloadFile(id, name) {
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.get(id);
            request.onsuccess = () => {
                const a = document.createElement('a');
                a.href = request.result.data;
                a.download = name;
                a.click();
            };
        }

        function printFile(id) {
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.get(id);
            request.onsuccess = () => {
                const img = new Image();
                img.src = request.result.data;
                img.onload = () => {
                    const win = window.open('');
                    if (!win) {
                        Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§', text: 'Ù¾Ù†Ø¬Ø±Ù‡ Ù¾Ø±ÛŒÙ†Øª Ø¨Ø§Ø² Ù†Ø´Ø¯.' });
                        return;
                    }
                    win.document.write(img.outerHTML);
                    win.document.close();
                    win.print();
                };
            };
        }

        function printAllFiles() {
            const name = document.getElementById('person-select-files').value;
            const files = personFiles[name] || [];
            if (files.length === 0) {
                Swal.fire({ icon: 'warning', title: 'Ø®Ø·Ø§', text: 'Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÛŒÙ†Øª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.' });
                return;
            }
            const win = window.open('');
            if (!win) {
                Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§', text: 'Ù¾Ù†Ø¬Ø±Ù‡ Ù¾Ø±ÛŒÙ†Øª Ø¨Ø§Ø² Ù†Ø´Ø¯.' });
                return;
            }
            win.document.write('<html><body dir="rtl">');
            files.forEach(f => {
                win.document.write(`<h3>${f.name} - ${f.desc || ''}</h3><img src="${f.data}" style="max-width:100%;"><br><br>`);
            });
            win.document.write('</body></html>');
            win.document.close();
            win.print();
        }

        function loadChart() {
            const ctx = document.getElementById('average-chart').getContext('2d');
            const labels = people.map(p => p.name);
            const data = people.map(p => {
                const ratings = reportcards[p.name] || [];
                return ratings.reduce((a, b) => a + b, 0) / ratings.length || 0;
            });
            new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Ù…Ø¹Ø¯Ù„', data, backgroundColor: '#ff4081' }] },
                options: { scales: { y: { beginAtZero: true, max: 5 } } }
            });
        }

        function loadSummary() {
            const select = document.getElementById('person-select-summary');
            select.innerHTML = '';
            people.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.text = p.name;
                select.add(opt);
            });
            updateSummary();
        }

        function updateSummary() {
            const name = document.getElementById('person-select-summary').value;
            const div = document.getElementById('summary-content');
            div.innerHTML = '';
            const p = people.find(person => person.name === name);
            if (p) {
                const ratings = reportcards[name] || [];
                const avg = ratings.reduce((a, b) => a + b, 0) / ratings.length || 0;
                const summary = `<h3>${p.name} <i class="fas fa-user"></i></h3>
                    <p>Ù†Ù‚Ø´: ${p.role || ''}</p>
                    <p>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ: ${p.personnel || ''}</p>
                    <p>Ù†Ø§Ù… Ù¾Ø¯Ø±: ${p.father || ''}</p>
                    <p>Ù…Ø´Ø®ØµØ§Øª Ø¯ÛŒÚ¯Ø±: ${p.other || ''}</p>
                    <p>Ù…Ø¹Ø¯Ù„: ${avg.toFixed(2)} â­</p>
                    <p>ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§: ${(notes[name] || []).join('<br> ')}</p>
                    <p>ÙØ§ÛŒÙ„â€ŒÙ‡Ø§: ${(personFiles[name] || []).map(f => `${f.name} (${f.desc || ''})`).join('<br> ')}</p>
                    <p>Ú©Ø§Ø±Ù†Ø§Ù…Ù‡: ${criteria.map((c, i) => `${c}: ${ratings[i] || 0} â­`).join('<br> ')}</p>
                    <p>Ù¾Ø§Ø¯Ø§Ø´ Ùˆ Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø§Ø±ÛŒ: ${(rewards[name] || []).map(r => `Ù¾Ø§Ø¯Ø§Ø´: ${r.amount}, Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø§Ø±ÛŒ: ${r.hours}`).join('<br> ')}</p>`;
                div.innerHTML = summary;
            }
        }

        function printSummary() {
            const name = document.getElementById('person-select-summary').value;
            const p = people.find(person => person.name === name);
            if (p) {
                const win = window.open('');
                if (!win) {
                    Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø§', text: 'Ù¾Ù†Ø¬Ø±Ù‡ Ù¾Ø±ÛŒÙ†Øª Ø¨Ø§Ø² Ù†Ø´Ø¯.' });
                    return;
                }
                win.document.write(`<html><body dir="rtl"><h1>Ú¯Ø²Ø§Ø±Ø´ ${p.name}</h1>${document.getElementById('summary-content').innerHTML}</body></html>`);
                win.document.close();
                win.print();
            }
        }

        function loadRewards() {
            const select = document.getElementById('person-select-rewards');
            select.innerHTML = '';
            people.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.text = p.name;
                select.add(opt);
            });
            select.onchange = updateRewards;
            updateRewards();
        }

        function addReward() {
            const name = document.getElementById('person-select-rewards').value;
            const amount = parseFloat(document.getElementById('reward-amount').value) || 0;
            const hours = parseFloat(document.getElementById('overtime-hours').value) || 0;
            if (!rewards[name]) rewards[name] = [];
            rewards[name].push({amount, hours});
            saveData();
            updateRewards();
            Swal.fire({ icon: 'success', title: 'Ù¾Ø§Ø¯Ø§Ø´ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', timer: 1500 });
        }

        function updateRewards() {
            const name = document.getElementById('person-select-rewards').value;
            const table = document.getElementById('rewards-table');
            table.innerHTML = '<tr><th>Ù¾Ø§Ø¯Ø§Ø´</th><th>Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø§Ø±ÛŒ</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>';
            let total = 0;
            (rewards[name] || []).forEach((r, i) => {
                const row = table.insertRow();
                row.innerHTML = `<td>${r.amount}</td><td>${r.hours}</td><td><button class="small-btn" onclick="deleteReward('${name}', ${i})">Ø­Ø°Ù <i class="fas fa-trash"></i></button></td>`;
                total += r.amount + (r.hours * 10);
            });
            document.getElementById('total-rewards').innerText = total.toFixed(2);
            // Rewards Chart
            const ctx = document.getElementById('rewards-chart').getContext('2d');
            const data = (rewards[name] || []).map((r, i) => ({ index: i + 1, total: r.amount + r.hours * 10 }));
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => `ÙˆØ±ÙˆØ¯ ${d.index}`),
                    datasets: [{ label: 'Ø¬Ù…Ø¹ Ù¾Ø§Ø¯Ø§Ø´ Ùˆ Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø§Ø±ÛŒ', data: data.map(d => d.total), borderColor: '#ff4081' }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        function deleteReward(name, i) {
            Swal.fire({
                title: 'Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ',
                text: 'Ø§ÛŒÙ† Ù¾Ø§Ø¯Ø§Ø´ Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†',
                cancelButtonText: 'Ø®ÛŒØ±'
            }).then(result => {
                if (result.isConfirmed) {
                    rewards[name].splice(i, 1);
                    saveData();
                    updateRewards();
                    Swal.fire({ icon: 'success', title: 'Ø­Ø°Ù Ø´Ø¯', timer: 1500 });
                }
            });
        }

        function exportData() {
            const data = {
                people, criteria, reportcards, notes, folderFiles, personFiles, rewards
            };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'education-app-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            Swal.fire({ icon: 'success', title: 'Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯', timer: 1500 });
        }

        function loadAll() {
            // Lazy Loading
            setTimeout(() => {
                loadPeopleDef();
                loadPeopleTable();
                loadCriteria();
                loadReportCard();
                loadNotes();
                loadFolder();
                loadFiles();
                loadChart();
                loadSummary();
                loadRewards();
            }, 100);
        }

        if (loggedIn) showDashboard('main-dashboard');
    </script>
</body>
</html>