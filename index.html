<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آموزش و پرورش - اپلیکیشن مدیریت</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.180.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/fontawesome@6.6.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vazirmatn@33.0.0/Vazirmatn-font-face.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            font-size: 12px;
            margin: 0;
            padding: 0;
            color: #fff;
            background: linear-gradient(135deg, #1a237e, #4fc3f7);
            overflow-x: hidden;
            animation: backgroundFlow 15s infinite ease-in-out;
            transition: background 0.3s;
        }
        body.dark-mode {
            background: linear-gradient(135deg, #121212, #424242);
            color: #ddd;
        }
        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://images.unsplash.com/photo-1503676260728-1f548d3d6f88') no-repeat center center fixed;
            background-size: cover;
            opacity: 0.3;
            z-index: -1;
            transform: translateZ(0);
        }
        @keyframes backgroundFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            transform-style: preserve-3d;
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0) rotateX(0deg) rotateY(0deg); }
            50% { transform: translateY(-20px) rotateX(5deg) rotateY(5deg); }
            100% { transform: translateY(0) rotateX(0deg) rotateY(0deg); }
        }
        .header {
            background: linear-gradient(90deg, #d81b60, #8e24aa);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 14px;
            border-radius: 10px;
            animation: pulseGlow 2s infinite ease-in-out;
        }
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 10px rgba(216, 27, 96, 0.7); }
            50% { box-shadow: 0 0 20px rgba(216, 27, 96, 1); }
            100% { box-shadow: 0 0 10px rgba(216, 27, 96, 0.7); }
        }
        .dashboard {
            display: none;
            animation: zoomIn3D 0.8s ease;
        }
        @keyframes zoomIn3D {
            from { transform: scale(0.8) rotateX(-10deg); opacity: 0; }
            to { transform: scale(1) rotateX(0deg); opacity: 1; }
        }
        .active { display: block; }
        button {
            padding: 8px 16px;
            margin: 5px;
            background: linear-gradient(45deg, #ff4081, #7c4dff);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            transform-style: preserve-3d;
        }
        button:hover {
            transform: translateZ(10px) scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .small-btn {
            padding: 4px 8px;
            font-size: 10px;
        }
        input, select, textarea {
            padding: 8px;
            margin: 5px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            width: calc(100% - 20px);
            transition: border 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border: 1px solid #ff4081;
            outline: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
        }
        th, td {
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px;
            text-align: center;
            color: white;
        }
        th {
            background: linear-gradient(45deg, #0288d1, #4fc3f7);
            cursor: pointer;
        }
        canvas {
            display: block;
            margin: 20px auto;
            border-radius: 10px;
        }
        .star-rating { display: inline-block; }
        .star-rating input { display: none; }
        .star-rating label {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: color 0.3s;
        }
        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #ffca28;
        }
        .file-preview {
            max-width: 100px;
            max-height: 100px;
            margin: 5px;
            border-radius: 5px;
        }
        @media (max-width: 600px) {
            .container { padding: 10px; }
            button { padding: 6px 12px; }
            input, select, textarea { width: 100%; }
        }
        footer {
            background: linear-gradient(90deg, #d81b60, #8e24aa);
            color: white;
            text-align: center;
            padding: 10px;
            position: relative;
            bottom: 0;
            width: 100%;
            border-radius: 0 0 10px 10px;
            animation: slideUp 1s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        #login {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            text-align: center;
        }
        #login input {
            margin: 10px 0;
            width: 80%;
        }
        #login button {
            width: 50%;
        }
    </style>
</head>
<body>
    <div class="background-overlay"></div>
    <div class="header">
        ﷽ بسم الله الرحمن الرحیم 📖<br>
        برنامه مدیریت آموزش و پرورش 🏫<br>
        تاریخ: <span id="date"></span> 📅
        <button onclick="toggleTheme()" style="float: left;"><i class="fas fa-moon"></i></button>
    </div>
    <div class="container">
        <!-- صفحه لوگین ساده -->
        <div id="login" class="dashboard active">
            <h2><i class="fas fa-sign-in-alt"></i> ورود</h2>
            <input type="text" id="username" placeholder="نام کاربری (1)" value="1">
            <input type="password" id="password" placeholder="رمز عبور (1)" value="1">
            <button onclick="login()"><i class="fas fa-sign-in-alt"></i> ورود</button>
            <p id="login-error" style="color: #ff4081;"></p>
        </div>

        <!-- داشبورد اصلی -->
        <div id="main-dashboard" class="dashboard">
            <h2><i class="fas fa-tachometer-alt"></i> داشبورد اصلی</h2>
            <p>نام کاربری: <span id="current-username"></span> <i class="fas fa-user"></i></p>
            <input type="password" id="new-password" placeholder="تغییر رمز عبور جدید">
            <button onclick="changePassword()">تغییر رمز <i class="fas fa-key"></i></button>
            <button onclick="showDashboard('people-def')">تعریف افراد <i class="fas fa-users"></i></button>
            <button onclick="showDashboard('people-table')">جدول افراد <i class="fas fa-table"></i></button>
            <button onclick="showDashboard('criteria-def')">تعریف معیارها <i class="fas fa-ruler"></i></button>
            <button onclick="showDashboard('reportcard')">کارنامه <i class="fas fa-file-alt"></i></button>
            <button onclick="showDashboard('notes')">یادداشت‌ها <i class="fas fa-sticky-note"></i></button>
            <button onclick="showDashboard('folder')">پوشه کار <i class="fas fa-folder"></i></button>
            <button onclick="showDashboard('files')">فایل‌های افراد <i class="fas fa-file"></i></button>
            <button onclick="showDashboard('chart')">نمودار معدل <i class="fas fa-chart-bar"></i></button>
            <button onclick="showDashboard('summary')">خلاصه گزارش <i class="fas fa-clipboard-list"></i></button>
            <button onclick="showDashboard('rewards')">پاداش و اضافه‌کاری <i class="fas fa-money-bill"></i></button>
            <button onclick="exportData()">خروجی داده‌ها <i class="fas fa-download"></i></button>
            <button onclick="logout()">خروج <i class="fas fa-sign-out-alt"></i></button>
        </div>

        <!-- داشبورد تعریف افراد -->
        <div id="people-def" class="dashboard">
            <h2><i class="fas fa-users"></i> تعریف افراد</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">بازگشت <i class="fas fa-arrow-right"></i></button>
            <input type="text" id="person-name" placeholder="نام">
            <input type="text" id="person-role" placeholder="نقش فرد">
            <input type="text" id="person-personnel" placeholder="کد پرسنلی">
            <input type="text" id="person-father" placeholder="نام پدر">
            <input type="text" id="person-other" placeholder="مشخصات دیگر">
            <select id="person-filter">
                <option>فیلتر: همه</option>
                <option>فعال</option>
                <option>غیرفعال</option>
            </select>
            <button onclick="addPerson()">ثبت <i class="fas fa-plus"></i></button>
            <table id="people-table-def">
                <tr><th>نام</th><th>نقش</th><th>کد پرسنلی</th><th>نام پدر</th><th>دیگر</th><th>عملیات</th></tr>
            </table>
        </div>

        <!-- داشبورد جدول افراد -->
        <div id="people-table" class="dashboard">
            <h2><i class="fas fa-table"></i> جدول افراد</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">بازگشت <i class="fas fa-arrow-right"></i></button>
            <input type="text" id="search-people" placeholder="جستجو...">
            <table id="people-table-full">
                <tr><th onclick="sortTable(0)">نام</th><th onclick="sortTable(1)">نقش</th><th onclick="sortTable(2)">کد پرسنلی</th><th onclick="sortTable(3)">نام پدر</th><th onclick="sortTable(4)">دیگر</th><th onclick="sortTable(5)">نمره ارزشیابی ⭐</th><th onclick="sortTable(6)">معدل ⭐</th></tr>
            </table>
        </div>

        <!-- داشبورد تعریف معیارها -->
        <div id="criteria-def" class="dashboard">
            <h2><i class="fas fa-ruler"></i> تعریف معیارها</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">بازگشت <i class="fas fa-arrow-right"></i></button>
            <input type="text" id="criterion-name" placeholder="نام معیار">
            <button onclick="addCriterion()">اضافه <i class="fas fa-plus"></i></button>
            <table id="criteria-table">
                <tr><th>معیار</th><th>عملیات</th></tr>
            </table>
        </div>

        <!-- داشبورد کارنامه -->
        <div id="reportcard" class="dashboard">
            <h2><i class="fas fa-file-alt"></i> کارنامه</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">بازگشت <i class="fas fa-arrow-right"></i></button>
            <select id="person-select-rc"></select>
            <div id="criteria-ratings"></div>
            <button onclick="saveReportCard()">ذخیره <i class="fas fa-save"></i></button>
            <p>معدل: <span id="average-rc"></span> ⭐</p>
        </div>

        <!-- داشبورد یادداشت‌ها -->
        <div id="notes" class="dashboard">
            <h2><i class="fas fa-sticky-note"></i> یادداشت‌ها</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">بازگشت <i class="fas fa-arrow-right"></i></button>
            <select id="person-select-notes"></select>
            <textarea id="note-text" placeholder="یادداشت بنویسید"></textarea>
            <button onclick="addNote()">اضافه <i class="fas fa-plus"></i></button>
            <ul id="notes-list"></ul>
        </div>

        <!-- داشبورد پوشه کار -->
        <div id="folder" class="dashboard">
            <h2><i class="fas fa-folder"></i> پوشه کار</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">بازگشت <i class="fas fa-arrow-right"></i></button>
            <input type="file" id="folder-file" multiple>
            <input type="text" id="folder-desc" placeholder="توضیحات فایل">
            <img id="folder-preview" class="file-preview" style="display: none;">
            <button onclick="addFolderFile()">افزودن <i class="fas fa-plus"></i></button>
            <table id="folder-table">
                <tr><th>نام فایل</th><th>توضیحات</th><th>عملیات</th></tr>
            </table>
        </div>

        <!-- داشبورد فایل‌های افراد -->
        <div id="files" class="dashboard">
            <h2><i class="fas fa-file"></i> فایل‌های افراد</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">بازگشت <i class="fas fa-arrow-right"></i></button>
            <select id="person-select-files"></select>
            <input type="file" id="person-file" multiple>
            <input type="text" id="person-desc" placeholder="توضیحات فایل">
            <img id="person-preview" class="file-preview" style="display: none;">
            <button onclick="addPersonFile()">افزودن <i class="fas fa-plus"></i></button>
            <button onclick="printAllFiles()">پرینت همه <i class="fas fa-print"></i></button>
            <table id="files-table">
                <tr><th>نام فایل</th><th>توضیحات</th><th>عملیات</th></tr>
            </table>
        </div>

        <!-- داشبورد نمودار -->
        <div id="chart" class="dashboard">
            <h2><i class="fas fa-chart-bar"></i> نمودار معدل</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">بازگشت <i class="fas fa-arrow-right"></i></button>
            <canvas id="average-chart" width="400" height="200"></canvas>
        </div>

        <!-- داشبورد خلاصه گزارش -->
        <div id="summary" class="dashboard">
            <h2><i class="fas fa-clipboard-list"></i> خلاصه گزارش</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">بازگشت <i class="fas fa-arrow-right"></i></button>
            <select id="person-select-summary" onchange="updateSummary()"></select>
            <button onclick="printSummary()">پرینت گزارش <i class="fas fa-print"></i></button>
            <div id="summary-content"></div>
        </div>

        <!-- داشبورد پاداش و اضافه‌کاری -->
        <div id="rewards" class="dashboard">
            <h2><i class="fas fa-money-bill"></i> پاداش و اضافه‌کاری</h2>
            <button class="small-btn" onclick="showDashboard('main-dashboard')">بازگشت <i class="fas fa-arrow-right"></i></button>
            <select id="person-select-rewards"></select>
            <input type="number" id="reward-amount" placeholder="مبلغ پاداش">
            <input type="number" id="overtime-hours" placeholder="ساعات اضافه‌کاری">
            <button onclick="addReward()">اضافه <i class="fas fa-plus"></i></button>
            <table id="rewards-table">
                <tr><th>پاداش</th><th>اضافه‌کاری</th><th>عملیات</th></tr>
            </table>
            <p>جمع کل: <span id="total-rewards">0</span> <i class="fas fa-money-bill"></i></p>
            <canvas id="rewards-chart" width="400" height="200"></canvas>
        </div>
    </div>
    <footer>
        ساخته شده توسط حسین هادی پور ❤️
    </footer>

    <script>
        // IndexedDB Setup
        let db;
        const request = indexedDB.open('EducationAppDB', 1);
        request.onupgradeneeded = event => {
            db = event.target.result;
            db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
        };
        request.onsuccess = event => {
            db = event.target.result;
        };
        request.onerror = () => console.error('IndexedDB error');

        let username = localStorage.getItem('username') || '1';
        let password = localStorage.getItem('password') || '1';
        let loggedIn = false;
        let people = JSON.parse(LZString.decompress(localStorage.getItem('people'))) || [];
        let criteria = JSON.parse(LZString.decompress(localStorage.getItem('criteria'))) || [
            "زمان‌شناسی ⏱️", "کار تیمی 🤝", "کیفیت کار 🏆", "ابتکار 💡", "مسئولیت‌پذیری 📌",
            "مهارت ارتباطی 🗣️", "یادگیری مداوم 📚", "مدیریت زمان ⌛", "حل مسئله 🧩", "انطباق‌پذیری 🔄",
            "رهبری 👑", "اخلاق حرفه‌ای ⚖️", "بهره‌وری ⚙️", "مشارکت 🎉", "رضایت مشتری 😊"
        ];
        let reportcards = JSON.parse(LZString.decompress(localStorage.getItem('reportcards'))) || {};
        let notes = JSON.parse(LZString.decompress(localStorage.getItem('notes'))) || {};
        let folderFiles = JSON.parse(LZString.decompress(localStorage.getItem('folderFiles'))) || [];
        let personFiles = JSON.parse(LZString.decompress(localStorage.getItem('personFiles'))) || {};
        let rewards = JSON.parse(LZString.decompress(localStorage.getItem('rewards'))) || {};

        // Three.js Animation (Optimized)
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        renderer.domElement.style.position = 'fixed';
        renderer.domElement.style.top = '0';
        renderer.domElement.style.left = '0';
        renderer.domElement.style.zIndex = '-2';
        renderer.domElement.style.pointerEvents = 'none';

        const geometry = new THREE.BufferGeometry();
        const vertices = [];
        for (let i = 0; i < 50; i++) {
            vertices.push(
                Math.random() * 100 - 50,
                Math.random() * 100 - 50,
                Math.random() * 100 - 50
            );
        }
        geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
        const material = new THREE.PointsMaterial({ color: 0xff4081, size: 0.5 });
        const particles = new THREE.Points(geometry, material);
        scene.add(particles);
        const light = new THREE.PointLight(0xffffff, 1, 100);
        light.position.set(10, 10, 10);
        scene.add(light);
        camera.position.z = 50;

        function animateParticles() {
            particles.rotation.y += 0.01;
            renderer.render(scene, camera);
            requestAnimationFrame(animateParticles);
        }
        animateParticles();

        // Theme Toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

        // Date Setup
        document.getElementById('date').innerText = new Date().toLocaleDateString('fa-IR');

        function saveData() {
            try {
                localStorage.setItem('username', username);
                localStorage.setItem('password', password);
                localStorage.setItem('people', LZString.compress(JSON.stringify(people)));
                localStorage.setItem('criteria', LZString.compress(JSON.stringify(criteria)));
                localStorage.setItem('reportcards', LZString.compress(JSON.stringify(reportcards)));
                localStorage.setItem('notes', LZString.compress(JSON.stringify(notes)));
                localStorage.setItem('folderFiles', LZString.compress(JSON.stringify(folderFiles)));
                localStorage.setItem('personFiles', LZString.compress(JSON.stringify(personFiles)));
                localStorage.setItem('rewards', LZString.compress(JSON.stringify(rewards)));
            } catch (e) {
                Swal.fire({
                    icon: 'error',
                    title: 'خطا',
                    text: 'حافظه محلی پر شده است. لطفاً برخی فایل‌ها را حذف کنید.',
                });
            }
        }

        function login() {
            const un = document.getElementById('username').value.trim();
            const pw = document.getElementById('password').value.trim();
            if (!un || !pw) {
                Swal.fire({ icon: 'error', title: 'خطا', text: 'لطفاً نام کاربری و رمز را وارد کنید.' });
                return;
            }
            if (un === username && pw === password) {
                loggedIn = true;
                showDashboard('main-dashboard');
                document.getElementById('current-username').innerText = username;
                loadAll();
                Swal.fire({ icon: 'success', title: 'خوش آمدید!', timer: 1500, showConfirmButton: false });
            } else {
                document.getElementById('login-error').innerText = 'نام کاربری یا رمز اشتباه است ❌';
            }
        }

        function changePassword() {
            const newPw = document.getElementById('new-password').value.trim();
            if (newPw && newPw.length >= 4) {
                password = newPw;
                saveData();
                Swal.fire({ icon: 'success', title: 'رمز تغییر یافت', timer: 1500 });
            } else {
                Swal.fire({ icon: 'error', title: 'خطا', text: 'رمز جدید باید حداقل ۴ کاراکتر باشد.' });
            }
        }

        function logout() {
            loggedIn = false;
            showDashboard('login');
            Swal.fire({ icon: 'info', title: 'خروج', text: 'شما با موفقیت خارج شدید.', timer: 1500 });
        }

        function showDashboard(id) {
            document.querySelectorAll('.dashboard').forEach(d => d.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'people-def') loadPeopleDef();
            if (id === 'people-table') loadPeopleTable();
            if (id === 'criteria-def') loadCriteria();
            if (id === 'reportcard') loadReportCard();
            if (id === 'notes') loadNotes();
            if (id === 'folder') loadFolder();
            if (id === 'files') loadFiles();
            if (id === 'chart') loadChart();
            if (id === 'summary') loadSummary();
            if (id === 'rewards') loadRewards();
        }

        function addPerson() {
            const name = document.getElementById('person-name').value.trim();
            const role = document.getElementById('person-role').value.trim();
            const personnel = document.getElementById('person-personnel').value.trim();
            const father = document.getElementById('person-father').value.trim();
            const other = document.getElementById('person-other').value.trim();
            if (!name) {
                Swal.fire({ icon: 'error', title: 'خطا', text: 'نام الزامی است.' });
                return;
            }
            people.push({name, role, personnel, father, other});
            saveData();
            loadPeopleDef();
            Swal.fire({ icon: 'success', title: 'ثبت شد', text: 'فرد با موفقیت اضافه شد.', timer: 1500 });
        }

        function loadPeopleDef() {
            const table = document.getElementById('people-table-def');
            table.innerHTML = '<tr><th>نام</th><th>نقش</th><th>کد پرسنلی</th><th>نام پدر</th><th>دیگر</th><th>عملیات</th></tr>';
            people.forEach((p, i) => {
                const row = table.insertRow();
                row.innerHTML = `<td>${p.name}</td><td>${p.role || ''}</td><td>${p.personnel || ''}</td><td>${p.father || ''}</td><td>${p.other || ''}</td>
                    <td><button class="small-btn" onclick="editPerson(${i})">ویرایش <i class="fas fa-edit"></i></button><button class="small-btn" onclick="deletePerson(${i})">حذف <i class="fas fa-trash"></i></button></td>`;
            });
        }

        function editPerson(i) {
            const p = people[i];
            document.getElementById('person-name').value = p.name;
            document.getElementById('person-role').value = p.role;
            document.getElementById('person-personnel').value = p.personnel;
            document.getElementById('person-father').value = p.father;
            document.getElementById('person-other').value = p.other;
            people.splice(i, 1);
            saveData();
        }

        function deletePerson(i) {
            Swal.fire({
                title: 'آیا مطمئن هستید؟',
                text: 'این فرد حذف خواهد شد!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'بله، حذف کن',
                cancelButtonText: 'خیر'
            }).then(result => {
                if (result.isConfirmed) {
                    people.splice(i, 1);
                    saveData();
                    loadPeopleDef();
                    Swal.fire({ icon: 'success', title: 'حذف شد', timer: 1500 });
                }
            });
        }

        function loadPeopleTable() {
            const table = document.getElementById('people-table-full');
            table.innerHTML = '<tr><th onclick="sortTable(0)">نام</th><th onclick="sortTable(1)">نقش</th><th onclick="sortTable(2)">کد پرسنلی</th><th onclick="sortTable(3)">نام پدر</th><th onclick="sortTable(4)">دیگر</th><th onclick="sortTable(5)">نمره ارزشیابی ⭐</th><th onclick="sortTable(6)">معدل ⭐</th></tr>';
            const search = document.getElementById('search-people').value.toLowerCase();
            people.filter(p => p.name.toLowerCase().includes(search) || (p.role || '').toLowerCase().includes(search)).forEach(p => {
                const ratings = reportcards[p.name] || criteria.map(() => 0);
                const avg = ratings.reduce((a, b) => a + b, 0) / ratings.length || 0;
                const evalScore = avg * 5;
                const row = table.insertRow();
                row.innerHTML = `<td>${p.name}</td><td>${p.role || ''}</td><td>${p.personnel || ''}</td><td>${p.father || ''}</td><td>${p.other || ''}</td>
                    <td>${evalScore.toFixed(2)}</td><td>${avg.toFixed(2)}</td>`;
            });
        }

        document.getElementById('search-people').addEventListener('input', loadPeopleTable);

        function sortTable(col) {
            people.sort((a, b) => {
                const values = [
                    a.name, a.role || '', a.personnel || '', a.father || '', a.other || '',
                    (reportcards[a.name] || criteria.map(() => 0)).reduce((x, y) => x + y, 0) / criteria.length || 0,
                    (reportcards[b.name] || criteria.map(() => 0)).reduce((x, y) => x + y, 0) / criteria.length || 0
                ];
                return values[col] > values[col + 5] ? 1 : -1;
            });
            loadPeopleTable();
        }

        function addCriterion() {
            const name = document.getElementById('criterion-name').value.trim();
            if (name) {
                criteria.push(name);
                saveData();
                loadCriteria();
                Swal.fire({ icon: 'success', title: 'معیار اضافه شد', timer: 1500 });
            }
        }

        function loadCriteria() {
            const table = document.getElementById('criteria-table');
            table.innerHTML = '<tr><th>معیار</th><th>عملیات</th></tr>';
            criteria.forEach((c, i) => {
                const row = table.insertRow();
                row.innerHTML = `<td>${c}</td><td><button class="small-btn" onclick="editCriterion(${i})">ویرایش <i class="fas fa-edit"></i></button><button class="small-btn" onclick="deleteCriterion(${i})">حذف <i class="fas fa-trash"></i></button></td>`;
            });
        }

        function editCriterion(i) {
            document.getElementById('criterion-name').value = criteria[i];
            criteria.splice(i, 1);
            saveData();
        }

        function deleteCriterion(i) {
            Swal.fire({
                title: 'آیا مطمئن هستید؟',
                text: 'این معیار حذف خواهد شد!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'بله، حذف کن',
                cancelButtonText: 'خیر'
            }).then(result => {
                if (result.isConfirmed) {
                    criteria.splice(i, 1);
                    saveData();
                    loadCriteria();
                    Swal.fire({ icon: 'success', title: 'حذف شد', timer: 1500 });
                }
            });
        }

        function loadReportCard() {
            const select = document.getElementById('person-select-rc');
            select.innerHTML = '';
            people.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.text = p.name;
                select.add(opt);
            });
            select.onchange = updateRatings;
            updateRatings();
        }

        function updateRatings() {
            const name = document.getElementById('person-select-rc').value;
            const div = document.getElementById('criteria-ratings');
            div.innerHTML = '';
            criteria.forEach((c, i) => {
                const ratingDiv = document.createElement('div');
                ratingDiv.innerHTML = `${c}: <div class="star-rating">
                    ${[5,4,3,2,1].map(n => `<input type="radio" id="star${i}-${n}" name="rate${i}" value="${n}" ${ (reportcards[name] && reportcards[name][i] === n) ? 'checked' : '' }><label for="star${i}-${n}">★</label>`).join('')}
                </div>`;
                div.appendChild(ratingDiv);
            });
            calculateAverage(name);
        }

        function saveReportCard() {
            const name = document.getElementById('person-select-rc').value;
            reportcards[name] = criteria.map((_, i) => parseInt(document.querySelector(`input[name="rate${i}"]:checked`)?.value || 0));
            saveData();
            calculateAverage(name);
            Swal.fire({ icon: 'success', title: 'کارنامه ذخیره شد', timer: 1500 });
        }

        function calculateAverage(name) {
            const ratings = reportcards[name] || [];
            const avg = ratings.reduce((a, b) => a + b, 0) / ratings.length || 0;
            document.getElementById('average-rc').innerText = avg.toFixed(2);
        }

        function loadNotes() {
            const select = document.getElementById('person-select-notes');
            select.innerHTML = '';
            people.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.text = p.name;
                select.add(opt);
            });
            select.onchange = updateNotes;
            updateNotes();
        }

        function addNote() {
            const name = document.getElementById('person-select-notes').value;
            const text = document.getElementById('note-text').value.trim();
            if (text) {
                if (!notes[name]) notes[name] = [];
                notes[name].push(text);
                saveData();
                updateNotes();
                Swal.fire({ icon: 'success', title: 'یادداشت اضافه شد', timer: 1500 });
            }
        }

        function updateNotes() {
            const name = document.getElementById('person-select-notes').value;
            const ul = document.getElementById('notes-list');
            ul.innerHTML = '';
            (notes[name] || []).forEach((n, i) => {
                const li = document.createElement('li');
                li.innerHTML = `${n} <button class="small-btn" onclick="editNote('${name}', ${i})">ویرایش <i class="fas fa-edit"></i></button><button class="small-btn" onclick="deleteNote('${name}', ${i})">حذف <i class="fas fa-trash"></i></button>`;
                ul.appendChild(li);
            });
        }

        function editNote(name, i) {
            document.getElementById('note-text').value = notes[name][i];
            notes[name].splice(i, 1);
            saveData();
        }

        function deleteNote(name, i) {
            Swal.fire({
                title: 'آیا مطمئن هستید؟',
                text: 'این یادداشت حذف خواهد شد!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'بله، حذف کن',
                cancelButtonText: 'خیر'
            }).then(result => {
                if (result.isConfirmed) {
                    notes[name].splice(i, 1);
                    saveData();
                    updateNotes();
                    Swal.fire({ icon: 'success', title: 'حذف شد', timer: 1500 });
                }
            });
        }

        function loadFolder() {
            const table = document.getElementById('folder-table');
            table.innerHTML = '<tr><th>نام فایل</th><th>توضیحات</th><th>عملیات</th></tr>';
            folderFiles.forEach((f, i) => {
                const row = table.insertRow();
                row.innerHTML = `<td>${f.name}</td><td>${f.desc || ''}</td><td><button class="small-btn" onclick="downloadFile(${f.id}, '${f.name}')">دانلود <i class="fas fa-download"></i></button><button class="small-btn" onclick="printFile(${f.id})">پرینت <i class="fas fa-print"></i></button><button class="small-btn" onclick="deleteFolderFile(${i}, ${f.id})">حذف <i class="fas fa-trash"></i></button></td>`;
            });
        }

        function addFolderFile() {
            const fileInput = document.getElementById('folder-file');
            const desc = document.getElementById('folder-desc').value.trim();
            const files = Array.from(fileInput.files);
            if (files.length === 0) return;
            files.forEach(file => {
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire({ icon: 'error', title: 'خطا', text: 'حجم فایل باید کمتر از ۵ مگابایت باشد.' });
                    return;
                }
                const reader = new FileReader();
                reader.onload = e => {
                    const transaction = db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const fileData = { name: file.name, data: e.target.result, desc };
                    const request = store.add(fileData);
                    request.onsuccess = () => {
                        folderFiles.push({ name: file.name, desc, id: request.result });
                        saveData();
                        loadFolder();
                        Swal.fire({ icon: 'success', title: 'فایل اضافه شد', timer: 1500 });
                    };
                };
                reader.readAsDataURL(file);
            });
            document.getElementById('folder-preview').style.display = 'none';
        }

        document.getElementById('folder-file').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const preview = document.getElementById('folder-preview');
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            }
        });

        function deleteFolderFile(index, id) {
            Swal.fire({
                title: 'آیا مطمئن هستید؟',
                text: 'این فایل حذف خواهد شد!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'بله، حذف کن',
                cancelButtonText: 'خیر'
            }).then(result => {
                if (result.isConfirmed) {
                    const transaction = db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    store.delete(id);
                    folderFiles.splice(index, 1);
                    saveData();
                    loadFolder();
                    Swal.fire({ icon: 'success', title: 'حذف شد', timer: 1500 });
                }
            });
        }

        function loadFiles() {
            const select = document.getElementById('person-select-files');
            select.innerHTML = '';
            people.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.text = p.name;
                select.add(opt);
            });
            select.onchange = updateFiles;
            updateFiles();
        }

        function addPersonFile() {
            const name = document.getElementById('person-select-files').value;
            const fileInput = document.getElementById('person-file');
            const desc = document.getElementById('person-desc').value.trim();
            const files = Array.from(fileInput.files);
            if (files.length === 0) return;
            files.forEach(file => {
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire({ icon: 'error', title: 'خطا', text: 'حجم فایل باید کمتر از ۵ مگابایت باشد.' });
                    return;
                }
                const reader = new FileReader();
                reader.onload = e => {
                    const transaction = db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const fileData = { name: file.name, data: e.target.result, desc, person: name };
                    const request = store.add(fileData);
                    request.onsuccess = () => {
                        if (!personFiles[name]) personFiles[name] = [];
                        personFiles[name].push({ name: file.name, desc, id: request.result });
                        saveData();
                        updateFiles();
                        Swal.fire({ icon: 'success', title: 'فایل اضافه شد', timer: 1500 });
                    };
                };
                reader.readAsDataURL(file);
            });
            document.getElementById('person-preview').style.display = 'none';
        }

        document.getElementById('person-file').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const preview = document.getElementById('person-preview');
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            }
        });

        function updateFiles() {
            const name = document.getElementById('person-select-files').value;
            const table = document.getElementById('files-table');
            table.innerHTML = '<tr><th>نام فایل</th><th>توضیحات</th><th>عملیات</th></tr>';
            (personFiles[name] || []).forEach((f, i) => {
                const row = table.insertRow();
                row.innerHTML = `<td>${f.name}</td><td>${f.desc || ''}</td><td><button class="small-btn" onclick="downloadFile(${f.id}, '${f.name}')">دانلود <i class="fas fa-download"></i></button><button class="small-btn" onclick="printFile(${f.id})">پرینت <i class="fas fa-print"></i></button><button class="small-btn" onclick="deletePersonFile('${name}', ${i}, ${f.id})">حذف <i class="fas fa-trash"></i></button></td>`;
            });
        }

        function deletePersonFile(name, index, id) {
            Swal.fire({
                title: 'آیا مطمئن هستید؟',
                text: 'این فایل حذف خواهد شد!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'بله، حذف کن',
                cancelButtonText: 'خیر'
            }).then(result => {
                if (result.isConfirmed) {
                    const transaction = db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    store.delete(id);
                    personFiles[name].splice(index, 1);
                    saveData();
                    updateFiles();
                    Swal.fire({ icon: 'success', title: 'حذف شد', timer: 1500 });
                }
            });
        }

        function downloadFile(id, name) {
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.get(id);
            request.onsuccess = () => {
                const a = document.createElement('a');
                a.href = request.result.data;
                a.download = name;
                a.click();
            };
        }

        function printFile(id) {
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.get(id);
            request.onsuccess = () => {
                const img = new Image();
                img.src = request.result.data;
                img.onload = () => {
                    const win = window.open('');
                    if (!win) {
                        Swal.fire({ icon: 'error', title: 'خطا', text: 'پنجره پرینت باز نشد.' });
                        return;
                    }
                    win.document.write(img.outerHTML);
                    win.document.close();
                    win.print();
                };
            };
        }

        function printAllFiles() {
            const name = document.getElementById('person-select-files').value;
            const files = personFiles[name] || [];
            if (files.length === 0) {
                Swal.fire({ icon: 'warning', title: 'خطا', text: 'هیچ فایلی برای پرینت وجود ندارد.' });
                return;
            }
            const win = window.open('');
            if (!win) {
                Swal.fire({ icon: 'error', title: 'خطا', text: 'پنجره پرینت باز نشد.' });
                return;
            }
            win.document.write('<html><body dir="rtl">');
            files.forEach(f => {
                win.document.write(`<h3>${f.name} - ${f.desc || ''}</h3><img src="${f.data}" style="max-width:100%;"><br><br>`);
            });
            win.document.write('</body></html>');
            win.document.close();
            win.print();
        }

        function loadChart() {
            const ctx = document.getElementById('average-chart').getContext('2d');
            const labels = people.map(p => p.name);
            const data = people.map(p => {
                const ratings = reportcards[p.name] || [];
                return ratings.reduce((a, b) => a + b, 0) / ratings.length || 0;
            });
            new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'معدل', data, backgroundColor: '#ff4081' }] },
                options: { scales: { y: { beginAtZero: true, max: 5 } } }
            });
        }

        function loadSummary() {
            const select = document.getElementById('person-select-summary');
            select.innerHTML = '';
            people.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.text = p.name;
                select.add(opt);
            });
            updateSummary();
        }

        function updateSummary() {
            const name = document.getElementById('person-select-summary').value;
            const div = document.getElementById('summary-content');
            div.innerHTML = '';
            const p = people.find(person => person.name === name);
            if (p) {
                const ratings = reportcards[name] || [];
                const avg = ratings.reduce((a, b) => a + b, 0) / ratings.length || 0;
                const summary = `<h3>${p.name} <i class="fas fa-user"></i></h3>
                    <p>نقش: ${p.role || ''}</p>
                    <p>کد پرسنلی: ${p.personnel || ''}</p>
                    <p>نام پدر: ${p.father || ''}</p>
                    <p>مشخصات دیگر: ${p.other || ''}</p>
                    <p>معدل: ${avg.toFixed(2)} ⭐</p>
                    <p>یادداشت‌ها: ${(notes[name] || []).join('<br> ')}</p>
                    <p>فایل‌ها: ${(personFiles[name] || []).map(f => `${f.name} (${f.desc || ''})`).join('<br> ')}</p>
                    <p>کارنامه: ${criteria.map((c, i) => `${c}: ${ratings[i] || 0} ⭐`).join('<br> ')}</p>
                    <p>پاداش و اضافه‌کاری: ${(rewards[name] || []).map(r => `پاداش: ${r.amount}, اضافه‌کاری: ${r.hours}`).join('<br> ')}</p>`;
                div.innerHTML = summary;
            }
        }

        function printSummary() {
            const name = document.getElementById('person-select-summary').value;
            const p = people.find(person => person.name === name);
            if (p) {
                const win = window.open('');
                if (!win) {
                    Swal.fire({ icon: 'error', title: 'خطا', text: 'پنجره پرینت باز نشد.' });
                    return;
                }
                win.document.write(`<html><body dir="rtl"><h1>گزارش ${p.name}</h1>${document.getElementById('summary-content').innerHTML}</body></html>`);
                win.document.close();
                win.print();
            }
        }

        function loadRewards() {
            const select = document.getElementById('person-select-rewards');
            select.innerHTML = '';
            people.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.text = p.name;
                select.add(opt);
            });
            select.onchange = updateRewards;
            updateRewards();
        }

        function addReward() {
            const name = document.getElementById('person-select-rewards').value;
            const amount = parseFloat(document.getElementById('reward-amount').value) || 0;
            const hours = parseFloat(document.getElementById('overtime-hours').value) || 0;
            if (!rewards[name]) rewards[name] = [];
            rewards[name].push({amount, hours});
            saveData();
            updateRewards();
            Swal.fire({ icon: 'success', title: 'پاداش اضافه شد', timer: 1500 });
        }

        function updateRewards() {
            const name = document.getElementById('person-select-rewards').value;
            const table = document.getElementById('rewards-table');
            table.innerHTML = '<tr><th>پاداش</th><th>اضافه‌کاری</th><th>عملیات</th></tr>';
            let total = 0;
            (rewards[name] || []).forEach((r, i) => {
                const row = table.insertRow();
                row.innerHTML = `<td>${r.amount}</td><td>${r.hours}</td><td><button class="small-btn" onclick="deleteReward('${name}', ${i})">حذف <i class="fas fa-trash"></i></button></td>`;
                total += r.amount + (r.hours * 10);
            });
            document.getElementById('total-rewards').innerText = total.toFixed(2);
            // Rewards Chart
            const ctx = document.getElementById('rewards-chart').getContext('2d');
            const data = (rewards[name] || []).map((r, i) => ({ index: i + 1, total: r.amount + r.hours * 10 }));
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => `ورود ${d.index}`),
                    datasets: [{ label: 'جمع پاداش و اضافه‌کاری', data: data.map(d => d.total), borderColor: '#ff4081' }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        function deleteReward(name, i) {
            Swal.fire({
                title: 'آیا مطمئن هستید؟',
                text: 'این پاداش حذف خواهد شد!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'بله، حذف کن',
                cancelButtonText: 'خیر'
            }).then(result => {
                if (result.isConfirmed) {
                    rewards[name].splice(i, 1);
                    saveData();
                    updateRewards();
                    Swal.fire({ icon: 'success', title: 'حذف شد', timer: 1500 });
                }
            });
        }

        function exportData() {
            const data = {
                people, criteria, reportcards, notes, folderFiles, personFiles, rewards
            };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'education-app-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            Swal.fire({ icon: 'success', title: 'داده‌ها خروجی گرفته شد', timer: 1500 });
        }

        function loadAll() {
            // Lazy Loading
            setTimeout(() => {
                loadPeopleDef();
                loadPeopleTable();
                loadCriteria();
                loadReportCard();
                loadNotes();
                loadFolder();
                loadFiles();
                loadChart();
                loadSummary();
                loadRewards();
            }, 100);
        }

        if (loggedIn) showDashboard('main-dashboard');
    </script>
</body>
</html>